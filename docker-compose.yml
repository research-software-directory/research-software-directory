version: '3'

services:

  admin:
    build:
      context: ./admin
    command: sh -c "rm -rf /build/* && cp -r /usr/share/nginx/html/* /build"
    container_name: rsd-admin
    volumes:
      - rsd_static_admin:/build

  auth:
    build:
      context: ./auth-github
    container_name: rsd-authentication
    env_file:
      - .env

  backend:
    build:
      context: ./backend
    container_name: rsd-backend
    depends_on:
      - database
    env_file:
      - .env

  database:
    build:
      context: ./database
    command: --bind_ip 0.0.0.0
    container_name: rsd-database
    entrypoint: /mongo.sh
    volumes:
      - ./docker-volumes/db:/data/db

  frontend:
    build:
      context: ./frontend
    container_name: rsd-frontend
    depends_on:
      - backend
    env_file:
      - .env
    volumes:
      - rsd_static_frontend:/shared_static
      - ./docker-volumes/oaipmh-cache:/static/oaipmh-cache

  nginx_ssl:
    container_name: rsd-nginx-ssl
    env_file:
      - .env
    image: rsdnlesc/docker-term-letsencrypt
    ports:
      - 443:443
      - 80:80
    restart: unless-stopped
    volumes:
      - ./docker-volumes/cert:/cert
      - ./docker-volumes/letsencrypt:/etc/letsencrypt

  reverse-proxy:
    build:
      context: ./reverse-proxy
    container_name: rsd-reverse-proxy
    depends_on:
      - frontend
      - backend
      - admin
      - auth
    env_file:
      - .env
    restart: unless-stopped
    volumes:
      - rsd_static_admin:/static_admin:ro
      - rsd_static_frontend:/static_frontend:ro

  tasks:
    build:
      context: ./tasks
    container_name: rsd-tasks
    env_file:
      - .env
    depends_on:
      - backend
      - database
    volumes:
      - ./docker-volumes/oaipmh-cache:/oaipmh-cache

volumes:
  rsd_static_admin:
  rsd_static_frontend:
